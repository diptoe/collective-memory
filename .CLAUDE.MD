# Collective Memory Platform

**Project:** Collective Memory
**Company:** Diptoe
**Owner:** Wayne Houlden (wayne@diptoe.com)
**Repository:** https://github.com/diptoe/collective-memory

## Overview

A persistent knowledge graph platform enabling multi-agent AI collaboration with:
- Flask API + SQLAlchemy backend
- PostgreSQL database (AlloyDB Omni in Docker)
- React frontend (Next.js) for human interaction, admin, and debugging
- MCP server for AI agent integration (Claude Code, Cursor, etc.)

## Tech Stack

### Backend
- **Framework:** Flask with Flask-RESTX (Swagger/OpenAPI)
- **ORM:** SQLAlchemy
- **Database:** PostgreSQL (AlloyDB Omni)
- **Pattern:** Following Jai API conventions

### Frontend
- **Framework:** Next.js 15 (App Router)
- **Styling:** Tailwind CSS v4
- **State:** Zustand
- **Pattern:** Following Jai React conventions

## Project Structure

```
collective-memory/
├── api/
│   ├── __init__.py           # Flask app factory
│   ├── config.py             # Environment configuration
│   ├── migration_manager.py  # Auto-discovery migrations
│   ├── models/
│   │   ├── base.py           # BaseModel with CRUD
│   │   ├── entity.py         # Knowledge graph entities
│   │   ├── relationship.py   # Entity relationships
│   │   ├── message.py        # Inter-agent messages
│   │   ├── agent.py          # Agent registration
│   │   ├── persona.py        # AI personas
│   │   ├── model.py          # AI model registry
│   │   ├── client.py         # Client types (claude-code, cursor, etc.)
│   │   ├── conversation.py   # Chat conversations
│   │   └── chat_message.py   # Chat messages
│   ├── routes/
│   │   ├── entities.py       # Entity CRUD
│   │   ├── relationships.py  # Relationship CRUD
│   │   ├── messages.py       # Inter-agent messaging
│   │   ├── agents.py         # Agent management
│   │   ├── personas.py       # Persona CRUD
│   │   ├── models.py         # AI model management
│   │   ├── clients.py        # Client management
│   │   ├── conversations.py  # Chat/conversation management
│   │   └── context.py        # Context injection queries
│   └── utils/
│       ├── graph.py          # Graph traversal helpers
│       └── keys.py           # UUID generation
├── cm_mcp/
│   ├── server.py             # MCP server entry point
│   ├── config.py             # MCP configuration
│   └── tools/                # MCP tool implementations
│       ├── entity.py         # Entity tools
│       ├── relationship.py   # Relationship tools
│       ├── context.py        # Context/RAG tools
│       ├── agent.py          # Agent identity tools
│       ├── message.py        # Messaging tools
│       └── github.py         # GitHub integration tools
├── web/
│   ├── src/
│   │   ├── app/              # Next.js pages
│   │   │   ├── agents/       # Agent list and detail pages
│   │   │   ├── models/       # Model list and detail pages
│   │   │   ├── personas/     # Persona management
│   │   │   ├── entities/     # Entity browsers
│   │   │   ├── messages/     # Message queue UI
│   │   │   └── graph/        # React Flow visualization
│   │   ├── components/       # React components
│   │   ├── lib/api/          # API client with debug integration
│   │   ├── lib/stores/       # Zustand stores
│   │   └── types/            # TypeScript types
│   └── package.json
├── Dockerfile.api            # API container
├── Dockerfile.mcp            # MCP server container
├── Dockerfile.web            # Web frontend container
├── docker-compose.yml        # Full stack deployment
├── requirements.txt
├── run.py                    # Flask entry point
├── .env                      # Environment config (not committed)
└── .env.example
```

## Brand Guide (Anthropic-Inspired)

### Color Palette
```css
--cm-charcoal: #131314;    /* Near-black, main text */
--cm-terracotta: #d97757;  /* Warm rust accent */
--cm-cream: #faf9f0;       /* Off-white background */
--cm-amber: #e8a756;       /* Secondary accent */
--cm-sienna: #a85a3b;      /* Darker rust */
--cm-sand: #e6dfd1;        /* Subtle backgrounds */
--cm-coffee: #5c4d3c;      /* Dark brown emphasis */
--cm-ivory: #fffef8;       /* Light background */
--cm-success: #5d8a66;     /* Muted green */
--cm-warning: #d9a557;     /* Amber warning */
--cm-error: #c45c5c;       /* Muted red */
--cm-info: #6b8fa8;        /* Slate blue */
```

### Typography
- **Primary:** Inter
- **Accent:** Source Serif 4
- **Monospace:** JetBrains Mono

## Database

### Connection (Docker - AlloyDB Omni)
```bash
docker run --name jai-omni -e POSTGRES_PASSWORD=Q57SZI -p 5432:5432 -d google/alloydbomni
```

**Connection string:** `postgresql://postgres:Q57SZI@localhost:5432/collective_memory`

### Core Tables
- `entities` - Knowledge graph nodes (Person, Project, Technology, Document, Organization, Concept, Repository, Commit, Issue)
- `relationships` - Graph edges with typed relationships
- `personas` - AI persona definitions
- `models` - AI model registry (Claude, GPT, Gemini, etc.)
- `clients` - Client types (claude-code, cursor, claude-desktop, etc.)
- `conversations` - Chat sessions with personas
- `chat_messages` - Individual messages
- `agents` - Registered AI agents
- `messages` - Inter-agent communication queue

## API Endpoints

- `GET/POST /api/entities` - Entity management
- `GET/POST /api/relationships` - Relationship management
- `GET/POST /api/personas` - Persona management
- `GET/POST /api/models` - AI model registry
- `GET/POST /api/clients` - Client type management
- `GET/POST /api/conversations` - Conversation management
- `DELETE /api/conversations/{key}/clear` - Clear conversation messages
- `GET/POST /api/agents` - Agent registration/status
- `GET/POST /api/messages/{channel}` - Inter-agent messaging
- `POST /api/context/query` - Context injection for prompts

**Swagger UI:** http://localhost:5001/api/docs

## Running the Project

### Option 1: Local Development

#### Start API
```bash
cd collective-memory
source venv/bin/activate
python run.py
```
API runs at http://localhost:5001/api

#### Start Frontend
```bash
cd collective-memory/web
npm run dev
```
Frontend runs at http://localhost:3000

#### Start MCP Server (for Claude Code, Cursor, etc.)
```bash
cd collective-memory
source venv/bin/activate
python -m cm_mcp.server
```

### Option 2: Docker Deployment
```bash
docker-compose up -d
```
See [DOCKER.md](DOCKER.md) for detailed instructions.

## Default Data

### Personas (seeded automatically)
1. **Backend Developer** - Backend specialist (terracotta)
2. **Frontend Developer** - Frontend specialist (amber)
3. **Full Stack Developer** - Full stack specialist (blue)
4. **Architect** - System architect (green)
5. **Consultant** - General AI consultant (purple)
6. **CM Developer** - Collective Memory platform specialist (gold)

### Supported Clients
- `claude-code` - Anthropic CLI
- `cursor` - Cursor IDE
- `claude-desktop` - Claude Desktop app
- `codex` - OpenAI Codex CLI
- `gemini-cli` - Google Gemini CLI

### Default User Entity
- Wayne Houlden (owner) - auto-created on first run

## Phase 1 Status: COMPLETE

- [x] Flask API with Flask-RESTX
- [x] SQLAlchemy models with auto-migrations
- [x] All CRUD routes
- [x] Next.js frontend
- [x] Chat interface with personas
- [x] Debug panel (Ctrl+Shift+D)
- [x] Dashboard, Entities, Personas, Agents, Messages pages

## Phase 2 Status: COMPLETE

- [x] React Flow graph visualization
- [x] AI model integration (Anthropic, OpenAI, Google)
- [x] Streaming chat responses (SSE)
- [x] MCP server with full tool suite
- [x] Agent identity and heartbeat system
- [x] GitHub integration (repos, commits, issues as entities)
- [x] Docker deployment support
- [x] Agent and Model detail pages

## Phase 3 (Future)

- [ ] Agent checkpointing/state persistence
- [ ] Multi-agent orchestration workflows
- [ ] Context injection optimization
- [ ] Semantic search with pgvector

## MCP Server Configuration

Add to your Claude Code or Cursor MCP settings:
```json
{
  "mcpServers": {
    "collective-memory": {
      "command": "python",
      "args": ["-m", "cm_mcp.server"],
      "cwd": "/path/to/collective-memory",
      "env": {
        "CM_API_URL": "http://localhost:5001"
      }
    }
  }
}
```

## Notes

- `metadata` is a reserved SQLAlchemy attribute - use `extra_data` instead
- Debug panel tracks all API requests for development
- Standard API response format: `{success, msg, data}`
- MCP tools use `mcp__collective-memory__` prefix
